import requests
import json
import pandas as pd
from .config import *
from .utils import *

"""
TODO: 
    - groundwaterstations
    - pumpstations
    - measuringstations
    - locations
    - timeseries
"""


def get_headers(api_key: str):
    """
    Function to create header, based on your Lizard API key
    
    Parameters:
    ----------
    api key : str
        Your Lizard API Key

    Returns:
    -------
    Lizard headers: dict
    """

    headers = {
        "username": "__key__",
        "password": api_key,
        "Content-Type": "application/json",
    }

    return headers


class Organisation:
    """
    This class takes an organisation uuid or name as argument.
    It enables to obtain all data related to the organisation for the relevant endpoints.
    For example: Organisation.get_locations() returns all locations under the provided organisation.

    NOTE: name option doesn't seem to work for special characters, such as +, & etc. Please lookup the uuid manually, and use it instead of name.

    Parameters:
    -----------
    headers : dict
        Lizard headers. Can be generated by get_headers function
    organisation_name: str
        Optional. If not provided, organisation_uuid is required
    organisation_uuid: str
        Optional. If not provided, organisation_name is required
    """

    def __init__(self, headers: dict = None, name: str = None, uuid: str = None):
        self.headers = headers

        if name == None:
            self.uuid = uuid
            self.url = f"{LIZARD_BASE_URL}/organisations/{self.uuid}"
            r = requests.get(self.url, headers=self.headers)

            if r.status_code != 200:
                raise TypeError("No organisatino found for provided uuid")
            else:
                self.name = r.json()["name"]
        if uuid == None:
            self.name = name
            url = f"{LIZARD_BASE_URL}/organisations/?name={self.name}"
            r = requests.get(url, headers=self.headers)
            count = r.json()["count"]

            if count == 0:
                raise TypeError("No organisation found for provided name")
            else:
                self.uuid = r.json()["results"][0]["uuid"]
                self.url = f"{LIZARD_BASE_URL}/organisations/{self.uuid}"

    def get_stats(self):
        """
        Returns the amount of assets for the organisation.

        Returns:
        --------
        dictionary {endpoints:count}
        """

        endpoint_list = [
            "filters",
            "groundwaterstations",
            "locations",
            "manholes",
            "measuringstations",
            "monitoringnetworks",
            "pumpstations",
            "rasters",
            "rastersources",
            "scenarios",
            "timeseries",
            "weirs",
            "wmslayers",
        ]

        count_dict = {}

        for endpoint in endpoint_list:
            if endpoint == "timeseries":
                url = f"{LIZARD_BASE_URL}/{endpoint}/?location__organisation__uuid={self.uuid}"
            else:
                url = f"{LIZARD_BASE_URL}/{endpoint}/?organisation__uuid={self.uuid}"

            r = requests.get(url=url, headers=self.headers)
            count = r.json()["count"]

            count_dict[endpoint] = count

        return count_dict

    def get_monitoringnetworks(self, dataformat: str = "list"):
        """
        Get all the monitoringngetworks related to the organisation.

        Parameters:
        ----------
        dataformat: str
            options:
                -'list' (default): returns list of uuids

                -'df': returns df of all data

        returns:
            list or df
        """
        results = get_organisation_endpoint_assets(
            endpoint="monitoringnetworks",
            dataformat=dataformat,
            organisation_uuid=self.uuid,
            json_field="uuid",
            headers=self.headers,
        )

        return results

    def get_groundwaterstations(self, dataformat: str = "list"):
        """
        Get all the groundwaterstations related to the organisation.

        Parameters:
        ----------
        dataformat: str
            options:
                -'list' (default): returns list of ids

                -'df': returns df of all data

        returns:
            list or df
        """
        results = get_organisation_endpoint_assets(
            endpoint="groundwaterstations",
            dataformat=dataformat,
            organisation_uuid=self.uuid,
            json_field="id",
            headers=self.headers,
        )

        return results

    def get_pumpstations(self, dataformat: str = "list"):
        """
        Get all the pumpstations related to the organisation.

        Parameters:
        ----------
        dataformat: str
            options:
                -'list' (default): returns list of ids

                -'df': returns df of all data

        returns:
            list or df
        """
        results = get_organisation_endpoint_assets(
            endpoint="pumpstations",
            dataformat=dataformat,
            organisation_uuid=self.uuid,
            json_field="id",
            headers=self.headers,
        )

        return results

    def get_measuringstations(self, dataformat: str = "list"):
        """
        Get all the measuringstations related to the organisation.

        Parameters:
        ----------
        dataformat: str
            options:
                -'list' (default): returns list of ids

                -'df': returns df of all data

        returns:
            list or df
        """
        results = get_organisation_endpoint_assets(
            endpoint="measuringstations",
            dataformat=dataformat,
            organisation_uuid=self.uuid,
            json_field="id",
            headers=self.headers,
        )

        return results

    def get_locations(self, dataformat: str = "list"):
        """
        Get all the locations related to the organisation.

        Parameters:
        ----------
        dataformat: str
            options:
                -'list' (default): returns list of uuids

                -'df': returns df of all data

        returns:
            list or df
        """
        results = get_organisation_endpoint_assets(
            endpoint="locations",
            dataformat=dataformat,
            organisation_uuid=self.uuid,
            json_field="uuid",
            headers=self.headers,
        )

        return results

    def get_timeseries(self, dataformat: str = "list"):
        """
        Get all the timeseries related to the organisation.

        Parameters:
        ----------
        dataformat: str
            options:
                -'list' (default): returns list of uuids

                -'df': returns df of all data

        returns:
            list or df
        """
        results = get_organisation_endpoint_assets(
            endpoint="timeseries",
            dataformat=dataformat,
            organisation_uuid=self.uuid,
            json_field="uuid",
            headers=self.headers,
        )

        return results


class Monitoringnetwork:
    """
    Class for working with monitoringnetworks.
    Initialization requires either name or uuid.

    args:
        -headers: Lizard headers. Can be generated by get_headers('API_KEY')
        -name
        -uuid

    Parameters:
    -----------
    headers : dict
        Lizard headers. Can be generated by get_headers function
    name: str
        Optional. If not provided, uuid is required
    uuid: str
        Optional. If not provided, name is required
    """

    def __init__(self, headers: dict = None, name: str = None, uuid: str = None):
        self.headers = headers

        if uuid == None:
            self.name = name
            url = f"{LIZARD_BASE_URL}/monitoringnetworks/?name={self.name}"
            r = requests.get(url, headers=self.headers)
            count = r.json()["count"]
            if count == 0:
                raise TypeError("No monitoringnetwork found for provided name")
            if count > 1:
                raise TypeError("Multiple monitoringnetworks found for provided name")
            else:
                self.uuid = r.json()["results"][0]["uuid"]
                self.url = f"{LIZARD_BASE_URL}/monitoringnetworks/{self.uuid}"

        if name == None:
            self.uuid = uuid
            self.url = f"{LIZARD_BASE_URL}/monitoringnetworks/{self.uuid}"

            r = requests.get(self.url, headers=self.headers)

            if r.status_code != 200:
                raise TypeError("No monitoringnetwork found for provided uuid")
            else:
                self.name = r.json()["name"]

    def get_stats(self):
        """
        Returns the amount of locations, observation_types, and timeseries.

        Returns:
        --------
        dictionary {endpoints:count}

        """
        endpoint_list = ["locations", "observationtypes", "timeseries"]
        count_dict = {}

        for endpoint in endpoint_list:
            url = f"{self.url}/{endpoint}/"
            r = requests.get(url=url, headers=self.headers)
            count = r.json()["count"]

            count_dict[endpoint] = count

        return count_dict

    def get_locations(self, dataformat: str = "list"):
        """
        Returns the locations related to the monitoringnetwork in a uuid list or df format
        
        Parameters:
        ----------
        dataformat: str
            options:
                -'list' (default): returns list of uuids

                -'df': returns df of all data

        returns:
            list or df
        
        """
        results = get_monitoringnetwork_enpoint_assets(
            endpoint="locations",
            dataformat=dataformat,
            url=self.url,
            headers=self.headers,
        )

        return results

    def get_timeseries(self, dataformat: str = "list"):
        """
        Returns the timeseries related to the monitoringnetwork in a uuid list or df format
        
        Parameters:
        ----------
        dataformat: str
            options:
                -'list' (default): returns list of uuids

                -'df': returns df of all data

        returns:
            list or df
        """
        
        results = get_monitoringnetwork_enpoint_assets(
            endpoint="timeseries",
            dataformat=dataformat,
            url=self.url,
            headers=self.headers,
        )

        return results

    def add_timeseries(self, timeseries_uuid_list: list):
        """
        Function to add timeseries to the monitoringnetwork.
        This automatically adds the locations related to the timeseries to the network

        Parameters:
        ------------
        timeseries_uuid_list : list
            list of uuids of the timeseries to add
        """
        if len(timeseries_uuid_list) == 0:
            print("The provided list of uuids is empty.")
        else:
            post_url = f"{self.url}/timeseries/"
            r = requests.post(
                url=post_url,
                headers=self.headers,
                data=json.dumps(timeseries_uuid_list),
            )
            r.raise_for_status()

    def delete_timeseries(self, timeseries_uuid_list: list):
        """
        Function to delete timeseries to the monitoringnetwork.
        This automatically deletes the locations related to the timeseries to the network

        Parameters:
        ------------
        timeseries_uuid_list : list
            list of uuids of the timeseries to delete

        """
        if len(timeseries_uuid_list) == 0:
            print("The provided list of uuids is empty.")
        else:
            post_url = f"{self.url}/timeseries/"
            r = requests.delete(
                url=post_url,
                headers=self.headers,
                data=json.dumps(timeseries_uuid_list),
            )
            r.raise_for_status()


# class Groundwaterstations:
#     """
#     Class for working with monitoringnetworks.
#     Initialization requires either uuid or organisation uuid.
#     If uuid is given, the class handles the provided groundwaterstation.
#     When the organisation uuid is provided, all the groundwaterstations under the organisation are used.


#     args:
#         -headers: Lizard headers. Can be generated by get_headers('API_KEY')
#         -name
#         -uuid
#     """

#     def __init__(self, headers=None, uuid=None):
#         self.headers = headers
#         self.uuid = uuid
